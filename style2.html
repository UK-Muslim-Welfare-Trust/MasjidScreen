<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wakefield Central Mosque - Prayer Timetable</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --surface-color: #242424;
            --primary-color: #bf9456;
            --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0;
            --highlight-color: #d4af37;

            /* "Super Responsive" Fluid Sizing using vmin */
            --font-size-xs: clamp(0.7rem, 1.8vmin, 1rem);
            --font-size-sm: clamp(0.8rem, 2.4vmin, 1.2rem);
            --font-size-md: clamp(1rem, 3.5vmin, 1.8rem);
            --font-size-lg: clamp(1.4rem, 6vmin, 3rem);
            --font-size-xl: clamp(1.8rem, 7vmin, 3.5rem);
            --font-size-xxl: clamp(4rem, 18vmin, 10rem);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Work Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            padding: 1.5vmin;
            overflow: hidden;
            background-image: radial-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .font-teko { font-family: 'Teko', sans-serif; font-weight: 600; letter-spacing: 1px; }
        .header, .footer { flex-shrink: 0; }

        .main-content {
            flex-grow: 1;
            display: flex;
            gap: 1.5vmin;
            margin: 1.5vmin 0;
            min-height: 0;
            flex-direction: row; /* Landscape-first */
        }

        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5vmin;
            min-width: 0;
        }
        .left-panel { flex: 4; }
        .right-panel {
            flex: 5;
            background-color: var(--surface-color);
            border-radius: 1.5vmin;
            padding: 2.5vmin;
        }
        
        @media (orientation: portrait) {
            .main-content { flex-direction: column; }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1vmin 2.5vmin;
            background-color: var(--surface-color);
            border-radius: 1.5vmin;
        }
        .logo img { height: 8vmin; }
        .logo-recolor { filter: invert(75%) sepia(13%) saturate(1558%) hue-rotate(359deg) brightness(91%) contrast(88%); }

        #fullscreen-btn {
            background: none; border: none; color: var(--text-secondary-color);
            cursor: pointer; padding: 0.5rem; transition: color 0.2s;
        }
        #fullscreen-btn:hover { color: var(--primary-color); }
        #fullscreen-btn svg { width: 3.5vmin; height: 3.5vmin; }
        :fullscreen #fullscreen-btn, :-webkit-full-screen #fullscreen-btn, :-moz-full-screen #fullscreen-btn { display: none; }

        .clock-display {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: var(--surface-color);
            border-radius: 1.5vmin;
            min-height: 0;
        }
        .main-digital-clock { font-size: var(--font-size-xxl); line-height: 0.9; }
        .main-date-display { font-size: var(--font-size-sm); color: var(--text-secondary-color); }

        /* --- NEW Message Box with Autoscroll --- */
        .message-box {
            background-color: var(--surface-color);
            padding: 2vmin;
            border-radius: 1.5vmin;
            flex-shrink: 0;
            min-height: 10vmin; /* Ensure it has some height */
            overflow: hidden; /* This is the viewport */
        }
        .message-content {
            font-size: var(--font-size-sm);
            font-style: italic;
            color: var(--text-secondary-color);
            white-space: normal;
        }
        .message-scroller {
            display: block;
        }
        
        .prayer-list {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: space-around;
        }
        .prayer-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.2vmin 2.5vmin; border-radius: 1vmin;
            border-left: 5px solid transparent;
            transition: all 0.3s ease-in-out;
        }
        .prayer-name { font-size: var(--font-size-lg); font-weight: 600; flex-basis: 40%; }
        .prayer-times { display: flex; justify-content: space-around; flex-basis: 60%; text-align: center; }
        .time-block-label { font-size: var(--font-size-sm); color: var(--text-secondary-color); }
        .time-block-time { font-size: var(--font-size-xl); line-height: 1.1; }
        
        .prayer-item.active {
            background: linear-gradient(90deg, rgba(191,148,86,0.15), transparent);
            border-left-color: var(--highlight-color);
        }
        .prayer-item.active .time-block-time { color: var(--primary-color); font-weight: 600; }

        .info-cards-bottom { 
            display: flex; gap: 1.5vmin; margin-top: auto; 
            padding-top: 1.5vmin; flex-shrink: 0;
        }
        .info-card {
            flex: 1; text-align: center; background-color: var(--bg-color);
            padding: 1.5vmin; border-radius: 1.5vmin;
        }
        .info-card-title { font-size: var(--font-size-sm); color: var(--text-secondary-color); }
        .info-card-time { font-size: var(--font-size-md); color: var(--primary-color); line-height: 1.2; }
        
        .footer {
            text-align: center; padding: 1.2vmin; background-color: var(--primary-color);
            color: #000; border-radius: 1.5vmin;
            font-weight: 600; font-size: var(--font-size-sm);
        }

        .phone-off-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; transition: opacity 0.5s ease;
        }
        .phone-off-overlay.visible { display: flex; opacity: 1; }
        .phone-icon { width: 15vmax; height: 15vmax; margin-bottom: 2rem; }
        .phone-off-text { font-size: 5vmax; font-weight: bold; text-align: center; }
        .overlay-clock { font-size: 3vmax; color: var(--text-secondary-color); }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">
            <img src="https://www.wakefieldcentralmosque.co.uk/assets/img/img/logo-mosque.svg" alt="Wakefield Central Mosque Logo" class="logo-recolor">
        </div>
        <button id="fullscreen-btn" title="Enter Fullscreen">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707m4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707m0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707m-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707"/>
            </svg>
        </button>
    </header>

    <main class="main-content">
        <div class="left-panel">
            <div class="clock-display">
                <div id="main-digital-clock" class="main-digital-clock font-teko">--:--:--</div>
                <div class="main-date-display">
                    <span id="gregorian-date">---</span> | <span id="hijri-date">---</span>
                </div>
            </div>
            <div class="message-box" id="message-viewport">
                <div class="message-content" id="message-content">"The mosques of Allah are only to be maintained by those who believe in Allah and the Last Day..."</div>
            </div>
        </div>
        <div class="right-panel">
            <div id="prayer-list" class="prayer-list">
                <!-- Prayer items will be dynamically inserted here -->
            </div>
             <div class="info-cards-bottom">
                <div class="info-card">
                    <div class="info-card-title">Sunrise</div>
                    <div class="info-card-time font-teko" id="sunrise-time">--:--</div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Zawwal</div>
                    <div class="info-card-time font-teko" id="zawwal-time">--:--</div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        Please donate generously to support your Masjid.
    </footer>

    <div id="phone-off-overlay" class="phone-off-overlay">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-phone-slash-fill phone-icon" viewBox="0 0 16 16">
            <path d="M3 2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zm6 11a1 1 0 1 0-2 0 1 1 0 0 0 2 0"/>
            <path d="m1.146 1.146.708.708a1 1 0 0 0 0 1.414l.708.708L1.146 1.146Zm1.414 1.414 11 11 .708-.708-11-11-.708.708Z"/>
        </svg>
        <div class="phone-off-text">Please Silence Your Phone</div>
        <div class="overlay-clock font-teko" id="overlay-clock">--:--:--</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDuq7jYQcKDKY3UWNxQwP51fKRwjCERuvo",
            authDomain: "wakefield-central-mosque.firebaseapp.com",
            projectId: "wakefield-central-mosque",
            storageBucket: "wakefield-central-mosque.appspot.com",
            messagingSenderId: "998395111777",
            appId: "1:998395111777:web:5492302e7279822d5cbd20",
            measurementId: "G-NXER4ENDE0"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const elements = {
            mainDigitalClock: document.getElementById('main-digital-clock'),
            gregorianDate: document.getElementById('gregorian-date'),
            hijriDate: document.getElementById('hijri-date'),
            prayerList: document.getElementById('prayer-list'),
            sunriseTime: document.getElementById('sunrise-time'),
            zawwalTime: document.getElementById('zawwal-time'),
            phoneOffOverlay: document.getElementById('phone-off-overlay'),
            overlayClock: document.getElementById('overlay-clock'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            messageViewport: document.getElementById('message-viewport'),
            messageContent: document.getElementById('message-content'),
        };

        let prayerTimesData = {}, jamaatTimesData = {}, messageText = '';

        const formatTime12h = (timeStr) => {
            if (!timeStr || !timeStr.includes(':')) return '--:--';
            const [hours, minutes] = timeStr.split(':');
            let h = parseInt(hours, 10), ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${minutes} ${ampm}`;
        };
        const timeToMinutes = (s) => !s || !s.includes(':') ? null : s.split(':').map(Number).reduce((h, m) => h * 60 + m);
        const minutesTo24h = (m) => m === null || isNaN(m) ? null : `${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;

        async function fetchHijriDate() {
            try {
                const today = new Date(), d = String(today.getDate()).padStart(2,'0'), m = String(today.getMonth()+1).padStart(2,'0'), y = today.getFullYear();
                const res = await fetch(`https://api.aladhan.com/v1/gToH?date=${d}-${m}-${y}`);
                if (!res.ok) throw new Error('Network failed');
                const data = await res.json();
                if (data.code === 200 && data.data.hijri) {
                    elements.hijriDate.textContent = `${data.data.hijri.day} ${data.data.hijri.month.en} ${data.data.hijri.year}H`;
                }
            } catch (e) { console.error("Could not fetch Hijri date:", e); }
        }

        function setupListeners() {
            const path = `artifacts/masjid-connect-app/public/data`;
            const today = new Date(), day = String(today.getDate()).padStart(2,'0'), month = String(today.getMonth()+1).padStart(2,'0');
            const calendarId = `${day}-${month}`;

            onSnapshot(doc(db, `${path}/prayerTimes/today`), snap => { if(snap.exists()) { jamaatTimesData = snap.data(); renderUI(); } });
            onSnapshot(doc(db, `${path}/prayerCalendar/${calendarId}`), snap => { if(snap.exists()) { prayerTimesData = snap.data(); renderUI(); } });
            onSnapshot(doc(db, `${path}/message`), snap => {
                messageText = (snap.exists() && snap.data().text) ? snap.data().text : '';
                renderMessage();
            });
        }

        function renderUI() {
            if (Object.keys(prayerTimesData).length === 0 || Object.keys(jamaatTimesData).length === 0) return;
            elements.prayerList.innerHTML = ['Fajr', 'Zuhr', 'Asr', 'Maghrib', 'Isha', 'Jummah'].map(prayer => {
                const id = `item-${prayer.toLowerCase()}`;
                if (prayer === 'Jummah') {
                    const j1 = formatTime12h(jamaatTimesData.Jumma), j2 = formatTime12h(jamaatTimesData.Jumma2);
                    return `<div class="prayer-item" id="${id}"><div class="prayer-name font-teko">Jummah</div><div class="prayer-times"><div class="time-block"><div class="time-block-label">1st Jama'at</div><div class="time-block-time font-teko">${j1}</div></div><div class="time-block"><div class="time-block-label">2nd Jama'at</div><div class="time-block-time font-teko">${j2}</div></div></div></div>`;
                } else {
                    const start = formatTime12h(prayerTimesData[prayer]);
                    const jamaat = prayer === 'Maghrib' ? start : formatTime12h(jamaatTimesData[prayer]);
                    return `<div class="prayer-item" id="${id}"><div class="prayer-name font-teko">${prayer}</div><div class="prayer-times"><div class="time-block"><div class="time-block-label">Start</div><div class="time-block-time font-teko">${start}</div></div><div class="time-block"><div class="time-block-label">Jama'at</div><div class="time-block-time font-teko">${jamaat}</div></div></div></div>`;
                }
            }).join('');
            elements.sunriseTime.textContent = formatTime12h(prayerTimesData.Sunrise);
            elements.zawwalTime.textContent = formatTime12h(minutesTo24h(timeToMinutes(prayerTimesData.Zuhr) - 10));
            highlightCurrentPrayer();
        }
        
        function renderMessage() {
            let txt = messageText.trim() || `"The mosques of Allah are only to be maintained by those who believe in Allah and the Last Day..." — Quran 9:18`;
            const { messageViewport, messageContent } = elements;
            
            const oldScroller = messageViewport.querySelector('.message-scroller');
            if (oldScroller) {
                messageViewport.innerHTML = '';
                messageViewport.appendChild(messageContent);
            }
            messageContent.style.animation = '';
            messageContent.textContent = txt;

            requestAnimationFrame(() => {
                const vpH = messageViewport.clientHeight, contentH = messageContent.scrollHeight;
                if (contentH > vpH) {
                    const duration = (contentH / vpH) * 15;
                    
                    const scroller = document.createElement('div');
                    scroller.className = 'message-scroller';
                    const copy1 = messageContent.cloneNode(true);
                    const copy2 = messageContent.cloneNode(true);
                    copy1.style.marginBottom = '2em';
                    scroller.append(copy1, copy2);
                    messageViewport.innerHTML = '';
                    messageViewport.appendChild(scroller);

                    const styleId = 'marquee-style';
                    document.getElementById(styleId)?.remove();
                    const styleEl = document.createElement('style');
                    styleEl.id = styleId;
                    styleEl.innerHTML = `@keyframes marqueeY { 0% { transform: translateY(0); } 100% { transform: translateY(-${contentH + 32}px); } }`;
                    document.head.appendChild(styleEl);
                    scroller.style.animation = `marqueeY ${duration}s linear infinite`;
                }
            });
        }

        function highlightCurrentPrayer() {
            if (Object.keys(prayerTimesData).length === 0) return;
            const now = new Date(), nowMin = now.getHours() * 60 + now.getMinutes(), isFriday = now.getDay() === 5;
            const order = isFriday ? ['Fajr','Jummah','Asr','Maghrib','Isha'] : ['Fajr','Zuhr','Asr','Maghrib','Isha'];
            const times = order.map(p => ({ name: p, start: timeToMinutes(prayerTimesData[p === 'Jummah' ? 'Zuhr' : p]) })).filter(t => t.start !== null).sort((a,b) => a.start - b.start);
            
            let current = '';
            if (times.length) {
                if (nowMin >= times[times.length-1].start || nowMin < times[0].start) current = times[times.length-1].name;
                else for(let i=0; i < times.length - 1; i++) if(nowMin >= times[i].start && nowMin < times[i+1].start) { current = times[i].name; break; }
            }
            document.querySelectorAll('.prayer-item.active').forEach(el => el.classList.remove('active'));
            if(current) document.getElementById(`item-${current.toLowerCase()}`)?.classList.add('active');
        }

        function checkPhoneOffMessage() {
            if (Object.keys(jamaatTimesData).length === 0 || Object.keys(prayerTimesData).length === 0) return;
            const nowMin = new Date().getHours() * 60 + new Date().getMinutes();
            const jamaatTimes = [jamaatTimesData.Fajr, jamaatTimesData.Zuhr, jamaatTimesData.Asr, prayerTimesData.Maghrib, jamaatTimesData.Isha, jamaatTimesData.Jumma, jamaatTimesData.Jumma2]
                .map(timeToMinutes).filter(t => t !== null);
            const show = jamaatTimes.some(t => nowMin >= t - 1 && nowMin <= t + 5);
            elements.phoneOffOverlay.classList.toggle('visible', show);
        }

        function updateClock() {
            const timeString = new Date().toLocaleTimeString('en-GB');
            elements.mainDigitalClock.textContent = timeString;
            elements.overlayClock.textContent = timeString;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e => console.error(e));
            else if (document.exitFullscreen) document.exitFullscreen();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            elements.gregorianDate.textContent = new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            fetchHijriDate();
            setupListeners();
            elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // Initial calls
            updateClock();
            highlightCurrentPrayer();
            renderMessage();

            // Main 1-second interval loop
            setInterval(() => {
                updateClock();
                highlightCurrentPrayer();
                checkPhoneOffMessage();
            }, 1000);
            
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(renderMessage, 250);
            });
        });
    </script>
</body>
</html>


