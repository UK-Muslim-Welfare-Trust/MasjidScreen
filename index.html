<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masjid Display — Final</title>

  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@500;600&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0f1113;
      --panel: #141618;
      --gold: #d4af37;
      --muted: #9aa0a6;
      --radius: 14px;
      --gap: 1.2vmin;
      --global-scale: 1;
      --clock-scale-large: 1.05;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%;background:var(--bg);color:#fff;font-family:'Work Sans',sans-serif;overflow:hidden}
    body{display:flex;flex-direction:column;justify-content:center;padding:var(--gap)}

    .wrap{
      display:grid;
      grid-template-columns: 1fr 1.4fr;
      gap:var(--gap);
      height:100%;
      width:100%;
    }

    .panel{
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03), 0 10px 40px rgba(0,0,0,0.55);
      display:flex;
      flex-direction:column;
      padding:1.2vmin;
      overflow:hidden;
    }

    /* LEFT panel: explicit rows 20/40/10/20/10 */
    .left{
      display:grid;
      grid-template-rows: 20% 40% 10% 20% 10%;
      align-items:center;
      justify-items:center;
      text-align:center;
      min-width:240px;
    }

    .masjid-logo{
      width: clamp(180px, 22vw, 420px);
      height: auto;
      cursor:pointer;
      transition: transform .25s ease, filter .25s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .masjid-logo:hover{ transform: scale(1.03); filter: drop-shadow(0 0 14px rgba(212,175,55,0.28)); }
    .masjid-logo img{ width:100%; height:auto; display:block; object-fit:contain;
      filter: invert(70%) sepia(20%) saturate(350%) hue-rotate(350deg) brightness(95%) contrast(90%);
    }

    .clock{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      width:100%;
    }

    .clock-time{
      font-family:'Teko',sans-serif;
      font-weight:600;
      font-size: clamp(3rem, 12vh, 14rem);
      line-height: 0.88;
      color: #fff;
      text-shadow: 0 0 26px rgba(212,175,55,0.22);
      transform: scale(var(--clock-scale-large));
    }

    .clock-sub{
      margin-top:0.8vmin;
      display:flex;
      flex-direction:column;
      gap:0.4vmin;
      align-items:center;
    }
    .gregorian{ font-size: clamp(1rem, 2.8vh, 3rem); color: #fff; }
    .hijri{ font-size: clamp(0.9rem, 2.2vh, 2.2rem); color: var(--gold); font-weight:600; }

    .spacer-row { width:100%; } /* empty breathing space */

    .message-block{
      width:90%;
      max-width:100%;
      min-height:80px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1vmin;
      border-radius: calc(var(--radius) - 4px);
      background: linear-gradient(180deg, rgba(212,175,55,0.02), rgba(255,255,255,0.005));
      overflow:hidden;
      text-align:center;
    }
    .message-viewport{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
    .message-content{ color: var(--muted); font-size: clamp(0.9rem, 1.9vh, 1.4rem); line-height:1.35; padding:4px 6px; }

    footer.left-foot{
      color: var(--muted);
      font-size: clamp(0.8rem, 1.6vh, 1.1rem);
      width:100%;
      text-align:center;
    }

    /* RIGHT panel */
    .right{ display:flex; flex-direction:column; gap:1vmin; align-items:stretch; justify-content:space-between; }

    .prayer-grid{
      display:grid;
      gap: 1vmin;
      width:100%;
      align-content:start;
      /* responsive columns */
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      /* keep grid area occupying most of right panel */
      flex: 1 1 auto;
      min-height: 0;
    }

    .prayer-card{
      background: rgba(255,255,255,0.02);
      border-radius: 10px;
      padding: 1vmin;
      display:flex;
      justify-content:space-between;
      align-items: center;
      min-height: clamp(72px, 8vmin, 110px);
      border: 1px solid rgba(255,255,255,0.03);
      position:relative;
      overflow:visible;
    }

    .prayer-left{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:flex-start;
      gap:6px;
    }
    .prayer-name{ font-family:'Teko',sans-serif; font-size: clamp(1.2rem, 2.8vh, 2.4rem); color: var(--gold); line-height:1; }
    .start-time{ color: var(--muted); font-size: clamp(0.8rem, 1.7vh, 1.2rem); }

    .prayer-right{ text-align:right; }
    .jamaat-time{ color: var(--gold); font-weight:700; font-size: clamp(1.1rem, 2.6vh, 2.2rem); }
    .jummah-extra{ color: var(--muted); font-size: clamp(0.75rem, 1.6vh, 1rem); margin-top:0.4vmin; }

    .prayer-card.active{
      border-color: rgba(212,175,55,0.30);
      box-shadow: 0 18px 50px rgba(212,175,55,0.08);
      animation: breathe 3.6s ease-in-out infinite;
      transform: translateY(-4px);
    }
    @keyframes breathe{
      0%{ box-shadow: 0 8px 30px rgba(212,175,55,0.06); background: rgba(255,255,255,0.02);}
      50%{ box-shadow: 0 30px 70px rgba(212,175,55,0.10); background: rgba(212,175,55,0.035);}
      100%{ box-shadow: 0 8px 30px rgba(212,175,55,0.06); background: rgba(255,255,255,0.02);}
    }

    .info-row{ display:flex; gap:1vmin; justify-content:center; align-items:center; margin-top:6px; }
    .info-mini{
      background: rgba(255,255,255,0.02);
      border-radius:10px;
      padding: 0.8vmin 1vmin;
      min-width:120px;
      text-align:center;
      color:var(--muted);
      font-size: clamp(0.9rem, 1.8vh, 1.2rem);
      border:1px solid rgba(255,255,255,0.02);
    }
    .info-mini.active{ color: var(--gold); box-shadow: 0 12px 30px rgba(212,175,55,0.06); animation: breathe 3.6s ease-in-out infinite; }

    @media (max-width: 920px){
      .wrap{ grid-template-columns: 1fr; grid-auto-rows: auto; }
      .left{ grid-template-rows: 18% 42% 8% 22% 10%; }
      .clock-time{ font-size: clamp(2rem, 10vh, 8rem); }
    }

    @media (min-width: 2200px){
      :root{ --global-scale: 1.08; --clock-scale-large: 1.12; }
    }
  </style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Masjid display">
    <section class="panel left" aria-label="Left panel logo clock message">
      <div class="masjid-logo" id="logo-toggle" title="Toggle fullscreen (click)">
        <img src="https://www.wakefieldcentralmosque.co.uk/assets/img/img/logo-mosque.svg" alt="Masjid logo">
      </div>

      <div class="clock" role="status" aria-live="polite">
        <div id="clock-time" class="clock-time">--:--:--</div>
        <div class="clock-sub">
          <div id="gregorian" class="gregorian">---</div>
          <div id="hijri" class="hijri">---</div>
        </div>
      </div>

      <div class="spacer-row" aria-hidden="true"></div>

      <div class="message-block" role="region" aria-live="polite" aria-atomic="true">
        <div id="message-viewport" class="message-viewport">
          <div id="message-content" class="message-content">Loading…</div>
        </div>
      </div>

      <footer class="left-foot" aria-hidden="false">Please donate generously to support your Masjid.</footer>
    </section>

    <section class="panel right" aria-label="Prayer timetable and info">
      <div id="prayer-grid" class="prayer-grid" role="list" aria-live="polite">
        <!-- Prayer cards injected by JS -->
      </div>

      <div class="info-row" aria-hidden="false">
        <div id="sunrise-card" class="info-mini"><div>Sunrise</div><div id="sunrise-time" class="time">--:--</div></div>
        <div id="zawwal-card" class="info-mini"><div>Zawwal</div><div id="zawwal-time" class="time">--:--</div></div>
      </div>
    </section>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Firebase config (kept as requested)
  const firebaseConfig = {
    apiKey: "AIzaSyDuq7jYQcKDKY3UWNxQwP51fKRwjCERuvo",
    authDomain: "wakefield-central-mosque.firebaseapp.com",
    projectId: "wakefield-central-mosque",
    storageBucket: "wakefield-central-mosque.appspot.com",
    messagingSenderId: "998395111777",
    appId: "1:998395111777:web:5492302e7279822d5cbd20",
    measurementId: "G-NXER4ENDE0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM
  const clockEl = document.getElementById('clock-time');
  const gregEl = document.getElementById('gregorian');
  const hijriEl = document.getElementById('hijri');
  const messageViewport = document.getElementById('message-viewport');
  const messageContent = document.getElementById('message-content');
  const grid = document.getElementById('prayer-grid');
  const sunriseTimeEl = document.getElementById('sunrise-time');
  const zawwalTimeEl = document.getElementById('zawwal-time');
  const sunriseCard = document.getElementById('sunrise-card');
  const zawwalCard = document.getElementById('zawwal-card');
  const logoToggle = document.getElementById('logo-toggle');

  // small hadith list (English only)
  const HADITHS = [
    "The best of you are those who learn the Qur'an and teach it.",
    "The most beloved deed to Allah is that which is most consistent, even if it is little.",
    "Whoever builds a mosque for Allah, Allah will build for him a house in Paradise.",
    "Charity extinguishes sin as water extinguishes fire.",
    "Prayer is the coolness of my eyes." 
  ];

  // state
  let prayerCalendar = {}; // daily prayer times
  let jamaatToday = {}; // jamaat times (prayerTimes/today)
  let messageDoc = {}; // message

  // helpers
  const pad = n => String(n).padStart(2,'0');

  function t12FromHM(hm){
    if(!hm || typeof hm !== 'string') return '--:--';
    const parts = hm.split(':');
    if(parts.length < 2) return hm;
    let hh = parseInt(parts[0],10);
    const mm = parseInt(parts[1],10);
    const suffix = hh >= 12 ? 'PM' : 'AM';
    hh = hh % 12 || 12;
    return `${hh}:${pad(mm)} ${suffix}`;
  }

  function hmToMinutes(hm){
    if(!hm || typeof hm !== 'string') return null;
    const p = hm.split(':');
    if(p.length < 2) return null;
    const hh = parseInt(p[0],10);
    const mm = parseInt(p[1],10);
    if(isNaN(hh) || isNaN(mm)) return null;
    return hh*60 + mm;
  }

  function minutesToHM(m){
    if(m===null || typeof m !== 'number' || isNaN(m)) return null;
    const hh = Math.floor(m/60) % 24;
    const mm = m % 60;
    return `${pad(hh)}:${pad(mm)}`;
  }

  // clock (guaranteed)
  function updateClock(){
    const now = new Date();
    // show 24-hour time for main clock (keeps consistent with prior design)
    clockEl.textContent = now.toLocaleTimeString('en-GB', { hour12: false });
    gregEl.textContent = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  }

  // hijri via aladhan
  async function updateHijri(){
    try{
      const d = new Date();
      const day = String(d.getDate()).padStart(2,'0');
      const month = String(d.getMonth()+1).padStart(2,'0');
      const year = d.getFullYear();
      const res = await fetch(`https://api.aladhan.com/v1/gToH?date=${day}-${month}-${year}`);
      if(!res.ok) throw new Error('Hijri fail');
      const json = await res.json();
      if(json?.data?.hijri){
        hijriEl.textContent = `${json.data.hijri.day} ${json.data.hijri.month.en} ${json.data.hijri.year}H`;
      } else {
        hijriEl.textContent = '—';
      }
    }catch(e){
      hijriEl.textContent = '—';
    }
  }

  // caching helpers
  function saveCache(){
    try{
      localStorage.setItem('masjid_prayerCalendar', JSON.stringify(prayerCalendar));
      localStorage.setItem('masjid_jamaatToday', JSON.stringify(jamaatToday));
      localStorage.setItem('masjid_message', JSON.stringify(messageDoc));
      localStorage.setItem('masjid_cache_ts', String(Date.now()));
    }catch(e){
      // ignore quota errors silently
      console.warn('Cache save failed', e);
    }
  }

  function loadCache(){
    try{
      const c1 = localStorage.getItem('masjid_prayerCalendar');
      const c2 = localStorage.getItem('masjid_jamaatToday');
      const c3 = localStorage.getItem('masjid_message');
      if(c1) prayerCalendar = JSON.parse(c1);
      if(c2) jamaatToday = JSON.parse(c2);
      if(c3) messageDoc = JSON.parse(c3);
    }catch(e){
      console.warn('Cache load failed', e);
    }
  }

  // message selection: prefer messageDoc.text -> messageDoc.message -> cached -> hadith
  function getDisplayMessage(){
    const msg = (messageDoc && (messageDoc.text || messageDoc.message));
    if(msg && String(msg).trim().length){
      return String(msg).trim();
    }
    // fallback to cached message if present
    try{
      const cached = localStorage.getItem('masjid_message');
      if(cached){
        const parsed = JSON.parse(cached);
        const m = parsed && (parsed.text || parsed.message);
        if(m && String(m).trim()) return String(m).trim();
      }
    }catch(e){}
    // last fallback: pick a hadith
    const pick = HADITHS[Math.floor(Math.random() * HADITHS.length)];
    return pick;
  }

  // render message centered; if taller than viewport, create vertical scroller
  function renderMessage(){
    const txt = getDisplayMessage();
    if(!messageViewport || !messageContent) return;
    messageViewport.innerHTML = '';
    const wrapper = document.createElement('div');
    wrapper.style.width = '100%';
    wrapper.style.display = 'flex';
    wrapper.style.justifyContent = 'center';
    wrapper.style.alignItems = 'center';
    wrapper.style.padding = '4px';
    const content = document.createElement('div');
    content.className = 'message-content';
    content.textContent = txt;
    wrapper.appendChild(content);
    messageViewport.appendChild(wrapper);

    requestAnimationFrame(()=> {
      const vpH = messageViewport.clientHeight;
      const cH = content.scrollHeight;
      if(cH > vpH + 8){
        // Build scroller with two copies and animate
        const scroller = document.createElement('div');
        scroller.style.width = '100%';
        scroller.style.display = 'block';
        scroller.style.whiteSpace = 'normal';
        const copy1 = content.cloneNode(true);
        const copy2 = content.cloneNode(true);
        copy1.style.marginBottom = '16px';
        copy2.style.marginBottom = '16px';
        scroller.appendChild(copy1);
        scroller.appendChild(copy2);
        messageViewport.innerHTML = '';
        messageViewport.appendChild(scroller);
        const base = 22; // seconds base
        const ratio = Math.max(cH / vpH, 1);
        const duration = Math.min(Math.max(base * ratio, 16), 120);
        const fname = 'msgScroll' + Math.floor(Math.random()*100000);
        const style = document.createElement('style');
        style.id = 'msg-scroll-style';
        style.textContent = `@keyframes ${fname}{0%{transform:translateY(0)}6%{transform:translateY(0)}94%{transform:translateY(-${cH}px)}100%{transform:translateY(-${cH}px)}}`;
        document.head.appendChild(style);
        scroller.style.animation = `${fname} ${duration}s linear infinite`;
      } else {
        // ensure centered
        wrapper.style.justifyContent = 'center';
      }
    });
  }

  // Render prayer grid
  function renderPrayerGrid(){
    grid.innerHTML = '';
    const order = ['Fajr','Zuhr','Asr','Maghrib','Isha','Jummah'];
    order.forEach(name => {
      const card = document.createElement('div');
      card.className = 'prayer-card';
      const left = document.createElement('div');
      left.className = 'prayer-left';
      const right = document.createElement('div');
      right.className = 'prayer-right';

      const prayerLabel = document.createElement('div');
      prayerLabel.className = 'prayer-name';
      prayerLabel.textContent = name;

      const startLabel = document.createElement('div');
      startLabel.className = 'start-time';
      // for jummah start we display Zuhr's start to match previous logic
      const startKey = (name === 'Jummah') ? 'Zuhr' : name;
      startLabel.textContent = 'Start: ' + t12FromHM(prayerCalendar[startKey]);

      left.appendChild(prayerLabel);
      left.appendChild(startLabel);

      const jamaDiv = document.createElement('div');
      jamaDiv.className = 'jamaat-time';
      // jamaat times from jamaatToday
      jamaDiv.textContent = t12FromHM(jamaatToday[name]);

      right.appendChild(jamaDiv);

      // jummah second line small
      if(name === 'Jummah'){
        const secondLine = document.createElement('div');
        secondLine.className = 'jummah-extra';
        secondLine.textContent = '2nd Jama’at at ' + t12FromHM(jamaatToday.Jumma2);
        right.appendChild(secondLine);
      }

      card.appendChild(left);
      card.appendChild(right);
      grid.appendChild(card);
    });

    // update info row times
    sunriseTimeEl.textContent = t12FromHM(prayerCalendar.Sunrise);
    // calculate Zawwal as Zuhr - 10 mins (if Zuhr exists)
    const zuhrH = prayerCalendar.Zuhr;
    const zuhrMin = hmToMinutes(zuhrH);
    const zawwalHM = (zuhrMin !== null) ? minutesToHM(zuhrMin - 10) : null;
    zawwalTimeEl.textContent = t12FromHM(zawwalHM);

    // apply active highlights
    highlightActive();
  }

  // highlight active prayer & info cards (breathing glow)
  function highlightActive(){
    // clear existing
    document.querySelectorAll('.prayer-card').forEach(c => c.classList.remove('active'));
    sunriseCard.classList.remove('active');
    zawwalCard.classList.remove('active');

    // determine current time in minutes
    const now = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();

    // prayer times array -> start minutes
    const order = ['Fajr','Zuhr','Asr','Maghrib','Isha'];
    const times = order.map(p => ({ name: p, start: hmToMinutes(prayerCalendar[p]) }))
      .filter(x => x.start !== null)
      .sort((a,b) => a.start - b.start);

    // determine current prayer (wrap-around)
    let currentName = null;
    if(times.length){
      if(nowMin >= times[times.length-1].start || nowMin < times[0].start){
        currentName = times[times.length-1].name;
      } else {
        for(let i=0;i<times.length-1;i++){
          if(nowMin >= times[i].start && nowMin < times[i+1].start){
            currentName = times[i].name; break;
          }
        }
      }
    }
    if(currentName){
      const el = document.querySelector(`#prayer-grid .prayer-card:nth-child(${( ['Fajr','Zuhr','Asr','Maghrib','Isha','Jummah'].indexOf(currentName) ) + 1})`);
      if(el) el.classList.add('active');
    }

    // highlight Sunrise window: for 15 minutes after sunrise
    const sunriseMin = hmToMinutes(prayerCalendar.Sunrise);
    if(sunriseMin !== null && nowMin >= sunriseMin && nowMin < sunriseMin + 15){
      sunriseCard.classList.add('active');
    }

    // highlight Zawwal: for 10 minutes before Zuhr start
    const zuhrMin2 = hmToMinutes(prayerCalendar.Zuhr);
    if(zuhrMin2 !== null && nowMin >= zuhrMin2 - 10 && nowMin < zuhrMin2){
      zawwalCard.classList.add('active');
    }
  }

  // On first load: try cached data
  loadCache();
  if(Object.keys(prayerCalendar).length) {
    renderPrayerGrid();
    renderMessage();
  } else {
    // initial placeholders until firebase arrives
    messageContent.textContent = 'Loading…';
  }

  // Setup Firestore listeners (keeps existing paths)
  const base = 'artifacts/masjid-connect-app/public/data';
  // prayerTimes/today (jamaat)
  try{
    onSnapshot(doc(db, `${base}/prayerTimes/today`), snap => {
      if(snap.exists()){
        jamaatToday = snap.data() || {};
        saveCache();
        renderPrayerGrid();
      }
    });
  }catch(e){ console.warn('jamaat listener failed', e); }

  // prayerCalendar/DD-MM
  function todayDocId(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    return `${dd}-${mm}`;
  }
  try{
    onSnapshot(doc(db, `${base}/prayerCalendar/${todayDocId()}`), snap => {
      if(snap.exists()){
        prayerCalendar = snap.data() || {};
        saveCache();
        renderPrayerGrid();
      }
    });
  }catch(e){ console.warn('calendar listener failed', e); }

  // message -> path: artifacts/.../message/message
  try{
    onSnapshot(doc(db, `${base}/message/message`), snap => {
      if(snap.exists()){
        messageDoc = snap.data() || {};
        saveCache();
        renderMessage();
      } else {
        // clear to fallback onto hadith or cached
        messageDoc = {};
        renderMessage();
      }
    });
  }catch(e){ console.warn('message listener failed', e); }

  // Offline fallback: if after 2s no firebase filled data, load cache and render
  setTimeout(()=> {
    const havePrayer = Object.keys(prayerCalendar).length;
    const haveJamaat = Object.keys(jamaatToday).length;
    if(!havePrayer || !haveJamaat){
      loadCache(); // attempt load again
      renderPrayerGrid();
      renderMessage();
    }
  }, 2000);

  // Clock + Hijri startup
  window.addEventListener('load', ()=> {
    updateClock();
    setInterval(updateClock, 1000);
    // hijri fetch
    updateHijri();
    // refresh hijri once per hour
    setInterval(updateHijri, 1000 * 60 * 60);
    // highlight interval
    setInterval(()=>{ highlightActive(); }, 1000);
    // re-render message on resize
    let rt; window.addEventListener('resize', ()=>{ clearTimeout(rt); rt = setTimeout(renderMessage, 250); });
  });

  // Fullscreen toggle via logo
  logoToggle.addEventListener('click', () => {
    if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  });

  // ensure the grid occupies right panel height: small safeguard to recalc scale if overflow
  function computeScaleAndFix(){
    // shrink clock scale slightly if total vertical overflow occurs on small devices
    const wrap = document.querySelector('.wrap');
    if(!wrap) return;
    const rect = wrap.getBoundingClientRect();
    const avail = window.innerHeight - (parseInt(getComputedStyle(document.body).paddingTop)||0) - (parseInt(getComputedStyle(document.body).paddingBottom)||0);
    if(rect.height > avail - 6){
      document.documentElement.style.setProperty('--clock-scale-large', '0.95');
      document.documentElement.style.setProperty('--global-scale', '0.88');
    } else {
      document.documentElement.style.setProperty('--clock-scale-large', '1.0');
      document.documentElement.style.setProperty('--global-scale', '1.0');
    }
  }
  window.addEventListener('resize', () => { computeScaleAndFix(); setTimeout(computeScaleAndFix, 220); });
  setTimeout(computeScaleAndFix, 300);
</script>
</body>
</html>